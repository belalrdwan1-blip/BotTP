<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محطة التداول (v5.2 - متعدد الاستراتيجيات)</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        /* نفس الـ CSS السابق، لا تغييرات كبيرة مطلوبة */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; }
        #main-container { display: flex; flex-direction: column; height: 100vh; }
        #chart_container { height: 45vh; background-color: #1e1e1e; } /* تقليل الارتفاع قليلاً */
        #controls-container { flex-grow: 1; overflow-y: auto; padding: 8px; border-top: 2px solid #bb86fc; }
        .card { background-color: #1e1e1e; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); overflow: hidden; }
        .card-header { background-color: #2a2a2a; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; font-size: 18px; color: #bb86fc; }
        .card-header .toggle-arrow { font-size: 24px; transition: transform 0.3s; transform: rotate(-90deg); }
        .card-content { padding: 20px; border-top: 1px solid #333; max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #cfcfcf; }
        input, select { width: 100%; padding: 10px; background-color: #333; border: 1px solid #555; border-radius: 4px; color: #e0e0e0; box-sizing: border-box; }
        .button { padding: 12px 20px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; box-sizing: border-box; transition: background-color 0.3s; }
        .btn-fetch { background-color: #03dac6; color: #121212; margin-top: 10px; }
        .btn-start { background-color: #4CAF50; color: white; margin-top: 10px; }
        .btn-stop { background-color: #f44336; color: white; margin-top: 10px; }
        #log-container { background-color: #000; border: 1px solid #444; height: 150px; overflow-y: auto; padding: 10px; font-family: "Courier New", Courier, monospace; font-size: 12px; border-radius: 4px; display: flex; flex-direction: column-reverse; }
        .hidden { display: none; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #03dac6; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="chart_container"></div>
        <div id="controls-container">
            
            <div class="card">
                <div class="card-header"><h2>1. الاتصال والتحكم</h2><span class="toggle-arrow"></span></div>
                <div class="card-content">
                    <div class="form-group">
                        <label for="api-key">مفتاح API الخاص بالوسيط</label>
                        <input type="password" id="api-key" placeholder="أدخل مفتاح API السري هنا">
                    </div>
                    <div class="form-group">
                        <label for="trading-account">اختر حساب التداول</label>
                        <select id="trading-account" disabled>
                            <option value="">أدخل مفتاح API أولاً ثم اضغط جلب</option>
                        </select>
                        <button id="fetch-accounts-btn" class="button btn-fetch">جلب الحسابات</button>
                    </div>
                    <hr style="border-color: #444; margin: 20px 0;">
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="dry-run-mode" style="margin-bottom: 0;">تفعيل وضع المحاكاة (آمن)</label>
                        <label class="switch"><input type="checkbox" id="dry-run-mode" checked><span class="slider"></span></label>
                    </div>
                    <button id="start-bot-btn" class="button btn-start">بدء التداول الآلي</button>
                    <button id="stop-bot-btn" class="button btn-stop" disabled>إيقاف التداول الآلي</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>2. الاستراتيجية والمؤشرات</h2><span class="toggle-arrow"></span></div>
                <div class="card-content">
                    <div class="form-group">
                        <label for="strategy-select">اختر استراتيجية التداول</label>
                        <select id="strategy-select">
                            <option value="doubling">الاستراتيجية الأولى (المضاعفة)</option>
                            <option value="trend_following">الاستراتيجية الثانية (تتبع الاتجاه)</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="asset-pair">اختر الزوج</label><select id="asset-pair"><option value="FX:EURUSD" selected>EUR/USD</option><option value="OANDA:XAUUSD">XAU/USD (الذهب)</option></select></div>
                    <div class="form-group"><label for="time-frame">الإطار الزمني</label><select id="time-frame"><option value="1">1 دقيقة</option><option value="5" selected>5 دقائق</option></select></div>
                    <hr style="border-color: #444; margin: 20px 0;">
                    <div class="form-group"><label for="st-length">Supertrend - الطول</label><input type="number" id="st-length" value="10"></div>
                    <div class="form-group"><label for="st-factor">Supertrend - المعامل</label><input type="number" id="st-factor" value="4"></div>
                    <div class="form-group"><label for="ma-period">Moving Average - الفترة</label><input type="number" id="ma-period" value="50"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><h2>3. إدارة رأس المال</h2><span class="toggle-arrow"></span></div>
                <div class="card-content">
                    <div class="form-group"><label for="initial-capital">رأس المال</label><input type="number" id="initial-capital" value="1000"></div>
                    <div class="form-group"><label for="risk-percent">نسبة المخاطرة الأولية (%)</label><input type="number" id="risk-percent" value="5"></div>
                    <!-- هذا الحقل خاص بالاستراتيجية الثانية فقط -->
                    <div class="form-group hidden" id="risk-divider-group">
                        <label for="risk-divider">مُجزّئ مخاطرة الربح (للاستراتيجية 2)</label>
                        <input type="number" id="risk-divider" value="4">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2>4. سجل العمليات</h2><span class="toggle-arrow"></span></div>
                <div class="card-content"><div id="log-container"></div></div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. تعريف عناصر الواجهة وكائنات الحالة ---
        const ui = {
            // ... (جميع العناصر السابقة)
            apiKey: document.getElementById('api-key'),
            tradingAccount: document.getElementById('trading-account'),
            fetchAccountsBtn: document.getElementById('fetch-accounts-btn'),
            dryRunMode: document.getElementById('dry-run-mode'),
            startBtn: document.getElementById('start-bot-btn'),
            stopBtn: document.getElementById('stop-bot-btn'),
            strategySelect: document.getElementById('strategy-select'),
            riskDividerGroup: document.getElementById('risk-divider-group'),
            logContainer: document.getElementById('log-container'),
            // ... (باقي العناصر)
            cardHeaders: document.querySelectorAll('.card-header'),
            assetPair: document.getElementById('asset-pair'),
            timeFrame: document.getElementById('time-frame'),
            stLength: document.getElementById('st-length'),
            stFactor: document.getElementById('st-factor'),
            maPeriod: document.getElementById('ma-period'),
            initialCapital: document.getElementById('initial-capital'),
            riskPercent: document.getElementById('risk-percent'),
            riskDivider: document.getElementById('risk-divider'),
        };

        const botState = {
            isRunning: false,
            apiKey: null,
            accountId: null,
            strategy: 'doubling',
            isDryRun: true,
            currentTrade: null,
            balance: 1000,
            mainInterval: null,
        };

        let tvWidget = null;

        // --- 2. الوظائف المساعدة والأساسية ---
        function log(message, type = 'info') { /* ... نفس الدالة ... */
            const now = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${now}] ${message}`;
            if (type === 'error') logEntry.style.color = '#f44336';
            if (type === 'success') logEntry.style.color = '#4CAF50';
            ui.logContainer.prepend(logEntry);
        }

        function toggleCard(event) { /* ... نفس الدالة ... */
            const header = event.currentTarget;
            const content = header.nextElementSibling;
            const wasCollapsed = !content.style.maxHeight || content.style.maxHeight === '0px';
            document.querySelectorAll('.card-content').forEach(c => {
                c.style.maxHeight = '0px';
                c.previousElementSibling.querySelector('.toggle-arrow').style.transform = 'rotate(-90deg)';
            });
            if (wasCollapsed) {
                content.style.maxHeight = content.scrollHeight + "px";
                header.querySelector('.toggle-arrow').style.transform = 'rotate(0deg)';
            }
        }
        
        // --- دالة جديدة للتحكم في الواجهة حسب الاستراتيجية ---
        function handleStrategyChange() {
            botState.strategy = ui.strategySelect.value;
            if (botState.strategy === 'trend_following') {
                ui.riskDividerGroup.classList.remove('hidden');
                log('تم اختيار استراتيجية تتبع الاتجاه. تم إظهار حقل مجزئ المخاطرة.');
            } else {
                ui.riskDividerGroup.classList.add('hidden');
                log('تم اختيار استراتيجية المضاعفة.');
            }
        }

        // --- 3. منطق الرسم البياني والاتصال بالوسيط ---
        const Datafeed = { /* ... نفس الكود الوهمي ... */ };
        function initChart() { /* ... نفس الدالة ... */ }
        function handleSettingsChange() { /* ... نفس الدالة ... */ }

        // --- دالة جديدة لجلب الحسابات ---
        async function fetchAccounts() {
            const apiKey = ui.apiKey.value;
            if (!apiKey) {
                log('خطأ: الرجاء إدخال مفتاح API أولاً.', 'error');
                return;
            }
            log('جاري جلب قائمة الحسابات...');

            // --- محاكاة جلب الحسابات ---
            if (ui.dryRunMode.checked) {
                log('**محاكاة**: تم العثور على حسابين.');
                // مسح القائمة القديمة
                ui.tradingAccount.innerHTML = '';
                // إضافة حسابات وهمية
                const accounts = [
                    { id: '12345-real', name: 'حساب حقيقي (12345)', balance: 5230.50 },
                    { id: '67890-demo', name: 'حساب تجريبي (67890)', balance: 10000.00 }
                ];
                accounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = `${acc.name} - الرصيد: ${acc.balance.toFixed(2)}$`;
                    ui.tradingAccount.appendChild(option);
                });
                ui.tradingAccount.disabled = false;
                return;
            }

            // --- الكود الحقيقي (سيتم كتابته لاحقًا) ---
            try {
                // const response = await fetch('https://api.exness.com/v1/accounts', {
                //     headers: { 'Authorization': `Bearer ${apiKey}` }
                // });
                // if (!response.ok) throw new Error('فشل جلب الحسابات. تحقق من مفتاح API.');
                // const data = await response.json();
                // ui.tradingAccount.innerHTML = '';
                // data.accounts.forEach(acc => { ... });
                log('الكود الحقيقي لجلب الحسابات لم يتم تنفيذه بعد.', 'info');
            } catch (error) {
                log(error.message, 'error');
            }
        }

        // --- 4. منطق البوت الأساسي ---
        function startBot() {
            botState.isDryRun = ui.dryRunMode.checked;
            // التحقق من الشروط
            if (!ui.apiKey.value && !botState.isDryRun) {
                log('خطأ: يجب إدخال مفتاح API أو تفعيل وضع المحاكاة.', 'error'); return;
            }
            if (!ui.tradingAccount.value && !botState.isDryRun) {
                log('خطأ: يجب اختيار حساب تداول أولاً.', 'error'); return;
            }

            botState.isRunning = true;
            botState.apiKey = ui.apiKey.value;
            botState.accountId = ui.tradingAccount.value;
            botState.strategy = ui.strategySelect.value;
            botState.balance = parseFloat(ui.initialCapital.value);

            // تعطيل عناصر التحكم
            ui.startBtn.disabled = true;
            ui.stopBtn.disabled = false;
            // ... (تعطيل باقي العناصر)
            
            log(`تم بدء البوت. الاستراتيجية: ${botState.strategy}. الحساب: ${botState.accountId || 'محاكاة'}.`, 'success');
            botState.mainInterval = setInterval(mainLoop, 10000);
        }

        function stopBot() { /* ... نفس الدالة ... */ }
        async function mainLoop() { /* ... نفس الدالة ... */ }
        function executeTrade(action, symbol, lotSize) { /* ... نفس الدالة ... */ }

        // --- 5. ربط الأحداث بالوظائف ---
        ui.cardHeaders.forEach(header => {
            header.addEventListener('click', toggleCard);
            const arrow = document.createElement('span');
            arrow.className = 'toggle-arrow';
            arrow.innerHTML = '►';
            header.appendChild(arrow);
        });
        firstCardHeader = ui.cardHeaders[0];
        if (firstCardHeader) { firstCardHeader.click(); }

        // ربط الأحداث الجديدة
        ui.strategySelect.addEventListener('change', handleStrategyChange);
        ui.fetchAccountsBtn.addEventListener('click', fetchAccounts);
        
        // ربط الأحداث القديمة
        [ui.assetPair, ui.timeFrame, ui.stLength, ui.stFactor, ui.maPeriod].forEach(el => el.addEventListener('change', handleSettingsChange));
        ui.startBtn.addEventListener('click', startBot);
        ui.stopBtn.addEventListener('click', stopBot);

        // التشغيل الأولي
        initChart();
        handleStrategyChange(); // للتأكد من إخفاء الحقل عند التحميل
    });
    </script>
</body>
</html>
